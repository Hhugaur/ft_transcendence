CREATE TABLE USERS (
	id INT AUTO_INCREMENT PRIMARY KEY,
	username VARCHAR(45) UNIQUE NOT NULL,
	password VARCHAR(255),
	avatar BLOB,
	ratio VARCHAR(5),
	win INT DEFAULT 0,
	lose INT DEFAULT 0
);

CREATE TABLE GAMES (
	id INT AUTO_INCREMENT PRIMARY KEY,
	red_player_id INT,
	blue_player_id INT,
	FOREIGN KEY (red_player_id) REFERENCES USERS(id),
	FOREIGN KEY (blue_player_id) REFERENCES USERS(id)
);

CREATE TABLE FRIENDS (
	user_id INT,
	friend_id INT,
	status ENUM('disconnected', 'connected', 'absent') NOT NULL DEFAULT 'disconnected',
	PRIMARY KEY (user_id, friend_id),
	FOREIGN KEY (user_id) REFERENCES USERS(id),
	FOREIGN KEY (friend_id) REFERENCES USERS(id)
);

CREATE TABLE GAMES_HISTORY (
	game_id INT PRIMARY KEY,
	red_player_id INT,
	blue_player_id INT,
	winner_id INT,
	score INT,
	touch_red INT,
	touch_blue INT,
	ball_max_speed FLOAT NOT NULL,
	date DATETIME NOT NULL,
	FOREIGN KEY (game_id) REFERENCES GAMES(id),
	FOREIGN KEY (winner_id) REFERENCES USERS(id),
	FOREIGN KEY (red_player_id) REFERENCES USERS(id),
	FOREIGN KEY (blue_player_id) REFERENCES USERS(id)
);

CREATE VIEW USER_STATS AS
SELECT
	id,
	username,
	win,
	lose,
	CONCAT(win, '/', GREATEST(win + lose, 1)) AS ratio
FROM USERS;

